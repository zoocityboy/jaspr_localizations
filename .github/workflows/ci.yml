name: Continuous Integration

on:
  push:
    branches: [main, develop, 'release/*']
    paths: ['lib/**', 'test/**', 'pubspec.yaml', 'analysis_options.yaml']
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PUB_CACHE: /tmp/pub_cache
  COVERAGE_THRESHOLD: 90

jobs:
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Dart SDK
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
          
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ${{ env.PUB_CACHE }}
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Install dependencies
        run: dart pub get --verbose
        
      - name: Verify formatting
        run: dart format --set-exit-if-changed .
        
      - name: Analyze code
        run: dart analyze --fatal-infos

      - name: Check package score
        run: |
          dart pub global activate pana
          dart pub global run pana --no-warning

  test-matrix:
    name: Test Suite
    runs-on: ubuntu-latest
    needs: code-quality
    timeout-minutes: 15
    
    strategy:
      fail-fast: false
      matrix:
        dart-version: ['3.9.0', '3.8.0']
        
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Dart SDK ${{ matrix.dart-version }}
        uses: dart-lang/setup-dart@v1
        with:
          sdk: ${{ matrix.dart-version }}
          
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ${{ env.PUB_CACHE }}
          key: ${{ runner.os }}-${{ matrix.dart-version }}-pub-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.dart-version }}-pub-
            ${{ runner.os }}-pub-
            
      - name: Install dependencies
        run: dart pub get
        
      - name: Run tests
        run: dart test --reporter=expanded --coverage=coverage
        
      - name: Generate coverage report
        if: matrix.dart-version == 'stable'
        run: |
          dart pub global activate coverage
          dart pub global run coverage:format_coverage --lcov --in=coverage --out=coverage/lcov.info --report-on=lib
          
      - name: Check coverage threshold
        if: matrix.dart-version == 'stable'
        run: |
          dart pub global activate test_coverage
          dart pub global run test_coverage --min-coverage=${{ env.COVERAGE_THRESHOLD }}
          
      - name: Upload coverage to Codecov
        if: matrix.dart-version == 'stable'
        uses: codecov/codecov-action@v3
        with:
          file: coverage/lcov.info
          flags: unittests
          name: jaspr_localizations-coverage
          
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.dart-version }}
          path: |
            coverage/
            test/
            
  build-verification:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: test-matrix
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Dart SDK
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
          
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ${{ env.PUB_CACHE }}
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: ${{ runner.os }}-pub-
          
      - name: Install dependencies
        run: dart pub get
        
      - name: Build package
        run: dart pub publish --dry-run
        
      - name: Verify package analysis
        run: |
          dart pub global activate pana
          dart pub global run pana --json --no-warning > analysis_result.json
          cat analysis_result.json
          
      - name: Check package score
        run: |
          SCORE=$(cat analysis_result.json | jq '.scores.grantedPoints // 0')
          TOTAL=$(cat analysis_result.json | jq '.scores.maxPoints // 1')
          PERCENTAGE=$(echo "scale=2; $SCORE * 100 / $TOTAL" | bc)
          echo "Package score: $SCORE/$TOTAL ($PERCENTAGE%)"
          if (( $(echo "$PERCENTAGE < 90" | bc -l) )); then
            echo "Package score is below 90%. Current: $PERCENTAGE%"
            exit 1
          fi
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            analysis_result.json
            .dart_tool/

  example-validation:
    name: Example Validation
    runs-on: ubuntu-latest
    needs: build-verification
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Dart SDK
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
          
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ${{ env.PUB_CACHE }}
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: ${{ runner.os }}-pub-
          
      - name: Install main package dependencies
        run: dart pub get
        
      - name: Install example dependencies
        working-directory: example
        run: dart pub get
        
      - name: Build example localization
        working-directory: example
        run: dart run build_runner build --delete-conflicting-outputs
        
      - name: Compile example application
        working-directory: example
        run: dart run jaspr_builder build
        
      - name: Verify example build
        working-directory: example
        run: |
          if [ ! -d "build" ]; then
            echo "Example build directory not found"
            exit 1
          fi
          echo "Example application built successfully"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: code-quality
    timeout-minutes: 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Dart SDK
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
          
      - name: Install dependencies
        run: dart pub get
        
      - name: Run security audit
        run: dart pub audit
        
      - name: Check for vulnerabilities
        run: |
          if dart pub audit --json | jq '.vulnerabilities | length' | grep -v '^0$'; then
            echo "Security vulnerabilities found!"
            dart pub audit
            exit 1
          fi
          echo "No security vulnerabilities found"

  aggregate-results:
    name: Aggregate Results
    runs-on: ubuntu-latest
    needs: [code-quality, test-matrix, build-verification, example-validation, security-scan]
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: Check job results
        run: |
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Test Matrix: ${{ needs.test-matrix.result }}"
          echo "Build Verification: ${{ needs.build-verification.result }}"
          echo "Example Validation: ${{ needs.example-validation.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          
          if [[ "${{ needs.code-quality.result }}" != "success" ]] || \
             [[ "${{ needs.test-matrix.result }}" != "success" ]] || \
             [[ "${{ needs.build-verification.result }}" != "success" ]] || \
             [[ "${{ needs.example-validation.result }}" != "success" ]] || \
             [[ "${{ needs.security-scan.result }}" != "success" ]]; then
            echo "One or more CI jobs failed"
            exit 1
          fi
          
          echo "All CI jobs completed successfully!"
          
      - name: Update commit status
        if: github.event_name == 'push'
        run: |
          echo "CI pipeline completed successfully for commit ${{ github.sha }}"